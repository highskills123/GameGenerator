"""
idle_rpg.py â€“ Code generator for the idle RPG genre.

Produces a complete, multi-file Flutter/Flame project sub-tree for an
idle RPG / incremental game.  Components auto-battle on a timer;
the player taps to add bonus damage.

When the spec contains a ``design_doc_data`` key (a dict produced by
``game_generator.ai.design_assistant.generate_idle_rpg_design``), the
generator also writes:
  - ``assets/data/quests.json``
  - ``assets/data/characters.json``
  - ``assets/data/enemies.json``
  - ``assets/data/items.json``      (if items list is present)
  - ``assets/data/locations.json``  (if locations list is present)
and wires five Flutter UI screens into a bottom-navigation main.dart:
  - ``lib/screens/quest_log_screen.dart``
  - ``lib/screens/characters_screen.dart``
  - ``lib/screens/shop_screen.dart``
  - ``lib/screens/combat_screen.dart``
  - ``lib/screens/settings_screen.dart``

Game mechanics included:
  - Idle auto-battle loop with configurable tick rate
  - Offline progress catch-up on game resume
  - Three upgrade categories (Combat, Defence, Economy) with cost scaling
  - Save/load persistence via SharedPreferences
  - Enemy roster loaded from assets/data/enemies.json
"""

from __future__ import annotations

import json
from typing import Any, Dict, List, Optional

from ..spec import GameSpec


def generate_files(spec: GameSpec) -> Dict[str, str]:
    """Return a dict of {relative_path: file_content} for the idle RPG."""
    title = spec.get("title", "Idle RPG")
    safe_name = _safe_class_name(title)
    design_doc: Optional[Dict[str, Any]] = spec.get("design_doc_data")
    dialogue_data: Optional[Dict[str, Any]] = spec.get("dialogue_data")

    files: Dict[str, str] = {}

    # Core Flame game files
    files["lib/game/game.dart"] = _game_dart(safe_name)
    files["lib/game/hero.dart"] = _hero_dart(safe_name)
    files["lib/game/enemy.dart"] = _enemy_dart(safe_name)
    files["lib/game/idle_manager.dart"] = _idle_manager_dart(safe_name, design_doc)
    files["lib/game/hud.dart"] = _hud_dart(safe_name)
    files["lib/game/upgrade_overlay.dart"] = _upgrade_overlay_dart(safe_name)
    files["lib/game/save_manager.dart"] = _save_manager_dart()
    files["lib/game/damage_text.dart"] = _damage_text_dart()
    files["lib/game/game_over_overlay.dart"] = _game_over_overlay_dart(safe_name)

    # JSON data files (always generated; populated from design doc when available)
    files["assets/data/quests.json"] = _quests_json(design_doc)
    files["assets/data/characters.json"] = _characters_json(design_doc)
    files["assets/data/enemies.json"] = _enemies_json(design_doc)
    if design_doc is None or design_doc.get("items"):
        files["assets/data/items.json"] = _items_json(design_doc)
    if design_doc is None or design_doc.get("locations"):
        files["assets/data/locations.json"] = _locations_json(design_doc)
    # NPC dialogue generated by GameDesignAgent (when available)
    files["assets/data/dialogue.json"] = _dialogue_json(dialogue_data)

    # Flutter UI screens
    files["lib/screens/quest_log_screen.dart"] = _quest_log_screen_dart(title)
    files["lib/screens/characters_screen.dart"] = _characters_screen_dart(title)
    files["lib/screens/shop_screen.dart"] = _shop_screen_dart(title)
    files["lib/screens/combat_screen.dart"] = _combat_screen_dart(title)
    files["lib/screens/settings_screen.dart"] = _settings_screen_dart(title)

    # Dungeon / Town / Skills data files
    files["assets/data/dungeon_layers.json"] = _dungeon_layers_json(design_doc)
    files["assets/data/skills.json"] = _skills_json()
    files["assets/data/town_map.json"] = _town_map_json()

    # New screens
    files["lib/screens/dungeon_screen.dart"] = _dungeon_screen_dart(title)
    files["lib/screens/town_map_screen.dart"] = _town_map_screen_dart(title)
    files["lib/screens/skills_screen.dart"] = _skills_screen_dart(safe_name, title)
    files["lib/screens/store_screen.dart"] = _store_screen_dart(title)

    # Ad service wrapper
    files["lib/services/ad_service.dart"] = _ad_service_dart()

    # Custom main.dart with bottom-navigation layout
    orientation = spec.get("orientation", "portrait")
    files["lib/main.dart"] = _main_dart_with_nav(safe_name, title, orientation)

    return files


def _safe_class_name(title: str) -> str:
    words = "".join(ch if ch.isalnum() or ch == " " else " " for ch in title).split()
    return "".join(w.capitalize() for w in words) if words else "MyGame"


def _game_dart(name: str) -> str:
    return f"""\
import 'package:flame/game.dart';
import 'package:flame/input.dart';
import 'package:flutter/material.dart';
import 'hero.dart';
import 'enemy.dart';
import 'idle_manager.dart';
import 'hud.dart';
import 'upgrade_overlay.dart';
import 'save_manager.dart';
import 'damage_text.dart';
import 'game_over_overlay.dart';
import '../services/ad_service.dart';

class {name}Game extends FlameGame with TapCallbacks {{
  // â”€â”€ Persistent state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  int gold = 0;
  int diamonds = 0;
  int wave = 1;
  int prestigeCount = 0;
  int currentDungeonLayer = 1;

  /// +10 % all stats per prestige level.
  double get prestigeBonus => 1.0 + prestigeCount * 0.10;

  // â”€â”€ Runtime settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /// Battle speed multiplier â€“ 1, 2, or 5.
  int speedMultiplier = 1;

  // â”€â”€ Session state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bool isGameOver = false;

  // â”€â”€ Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late final AdService adService;

  // â”€â”€ Entities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  late GameHero hero;
  late GameEnemy enemy;
  late IdleManager idleManager;
  late final SaveManager saveManager;

  @override
  Future<void> onLoad() async {{
    await super.onLoad();

    adService = AdService();
    await adService.initialize();

    saveManager = SaveManager();
    await saveManager.load();
    gold = saveManager.gold;
    diamonds = saveManager.diamonds;
    wave = saveManager.wave;
    prestigeCount = saveManager.prestigeCount;
    currentDungeonLayer = saveManager.currentDungeonLayer;

    // Background
    add(RectangleComponent(size: size, paint: Paint()..color = const Color(0xFF1a1a2e)));

    // Hero â€“ restore persisted level/XP
    hero = GameHero(game: this);
    hero.heroLevel = saveManager.heroLevel;
    hero.xp = saveManager.xp;
    hero.xpToNextLevel = hero.heroLevel * 50;
    hero.applyPrestige(prestigeBonus);
    await hero.onLoad();
    add(hero);

    // Enemy (boss every 5th wave)
    enemy = GameEnemy(game: this, wave: wave);
    await enemy.onLoad();
    add(enemy);

    // Idle auto-battle manager
    idleManager = IdleManager(game: this);
    add(idleManager);

    // HUD
    add(Hud());

    // Overlays
    overlays.addEntry(
      'Upgrade',
      (ctx, g) => UpgradeOverlay(game: g as {name}Game),
    );
    overlays.addEntry(
      'GameOver',
      (ctx, g) => GameOverOverlay(game: g as {name}Game),
    );
  }}

  @override
  void onRemove() {{
    _persist();
    super.onRemove();
  }}

  void _persist() {{
    saveManager.save(
      gold: gold,
      diamonds: diamonds,
      wave: wave,
      heroLevel: hero.heroLevel,
      xp: hero.xp,
      prestigeCount: prestigeCount,
      currentDungeonLayer: currentDungeonLayer,
    );
  }}

  // â”€â”€ Tap: player manually attacks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  @override
  void onTapDown(TapDownEvent event) {{
    if (isGameOver) return;
    final (dmg, isCrit) = hero.attack(enemy, bonus: hero.tapDamage);
    add(DamageText(
      amount: dmg,
      position: event.localPosition.clone(),
      isCrit: isCrit,
    ));
    _checkEnemyDead();
  }}

  // Called by IdleManager auto-attack tick.
  void autoAttack() {{
    if (isGameOver || !enemy.isMounted) return;
    final pos = enemy.position + enemy.size / 2;
    final (dmg, isCrit) = hero.attack(enemy);
    add(DamageText(amount: dmg, position: pos, isCrit: isCrit));
    _checkEnemyDead();
  }}

  // Called by IdleManager enemy counter-attack tick.
  void enemyCounterAttack() {{
    if (isGameOver || enemy.hp <= 0) return;
    heroTakeDamage(enemy.attackPower);
  }}

  void _checkEnemyDead() {{
    if (enemy.hp > 0) return;
    final baseGold = wave * 10 * (enemy.isBoss ? 5 : 1);
    gold += (baseGold * hero.goldMultiplier * prestigeBonus).round();
    hero.gainXp(wave * (enemy.isBoss ? 10 : 3));
    // Award 1 diamond every 10 waves, 5 for boss wave
    if (enemy.isBoss) {{
      diamonds += 5;
    }} else if (wave % 10 == 0) {{
      diamonds += 1;
    }}
    wave++;
    // Advance dungeon layer every 10 waves
    if (wave > currentDungeonLayer * 10) {{
      currentDungeonLayer++;
    }}
    _persist();
    _respawnEnemy();
    overlays.add('Upgrade');
  }}

  void heroTakeDamage(int amount) {{
    hero.hp = (hero.hp - amount).clamp(0, hero.maxHp);
    if (hero.hp <= 0) _triggerGameOver();
  }}

  void _triggerGameOver() {{
    if (isGameOver) return;
    isGameOver = true;
    _persist();
    pauseEngine();
    overlays.add('GameOver');
  }}

  /// Prestige: reset progress, keep permanent bonus.
  void prestige() {{
    prestigeCount++;
    gold = 0;
    wave = 1;
    currentDungeonLayer = 1;
    hero.resetForPrestige(prestigeBonus);
    isGameOver = false;
    overlays.remove('GameOver');
    overlays.remove('Upgrade');
    _persist();
    resumeEngine();
    _respawnEnemy();
  }}

  /// Try again without prestige (hero restored to full HP).
  void tryAgain() {{
    hero.hp = hero.maxHp;
    isGameOver = false;
    overlays.remove('GameOver');
    resumeEngine();
    _respawnEnemy();
  }}

  /// Award diamonds (from IAP callback or bonuses).
  void earnDiamonds(int amount) {{
    diamonds += amount;
    _persist();
  }}

  /// Show a rewarded ad; on success double the current gold.
  void watchAdForGold({{required VoidCallback onComplete}}) {{
    adService.showRewardedAd(
      onRewarded: (bonus) {{
        gold += gold; // 2Ã— current gold
        _persist();
        onComplete();
      }},
    );
  }}

  /// Whether the current wave is a boss wave.
  bool get isBossWave => wave % 5 == 0 && wave > 0;

  bool get isAdReady => adService.isAdReady;

  void _respawnEnemy() {{
    enemy.removeFromParent();
    enemy = GameEnemy(game: this, wave: wave);
    enemy.onLoad().then((_) => add(enemy));
  }}
}}
"""


def _hero_dart(name: str) -> str:
    return f"""\
import 'dart:math';
import 'package:flame/components.dart';
import 'package:flutter/material.dart';
import 'enemy.dart';
import 'game.dart';

class GameHero extends PositionComponent {{
  final {name}Game game;

  // Shared RNG for crit rolls
  static final _rng = Random();

  // â”€â”€ Upgrade levels (player-purchased) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  int level = 1;
  int defenceLevel = 1;
  int economyLevel = 1;

  // â”€â”€ Auto-leveling from XP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  int heroLevel = 1;
  int xp = 0;
  int xpToNextLevel = 50;

  // â”€â”€ Combat stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  int attackPower = 10;
  int tapDamage = 5;
  int maxHp = 100;
  int hp = 100;
  double goldMultiplier = 1.0;

  // â”€â”€ Flash effect on attack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bool _isFlashing = false;
  double _flashTimer = 0;

  GameHero({{required this.game}}) : super(size: Vector2(64, 64));

  @override
  Future<void> onLoad() async {{
    position = Vector2(game.size.x * 0.25 - 32, game.size.y * 0.5 - 32);
  }}

  /// Apply prestige multiplier to base stats.
  void applyPrestige(double bonus) {{
    attackPower = (10 * bonus).round();
    tapDamage = (5 * bonus).round();
    maxHp = (100 * bonus).round();
    hp = maxHp;
  }}

  /// Attack target; returns (damage dealt, isCrit).
  (int, bool) attack(GameEnemy target, {{int bonus = 0}}) {{
    final isCrit = _rng.nextInt(100) < 15; // 15% crit chance
    final dmg = (attackPower + bonus) * (isCrit ? 2 : 1);
    target.takeDamage(dmg);
    _isFlashing = true;
    _flashTimer = 0.1;
    return (dmg, isCrit);
  }}

  /// Award XP and auto-level up as many times as needed.
  void gainXp(int amount) {{
    xp += amount;
    while (xp >= xpToNextLevel) {{
      xp -= xpToNextLevel;
      heroLevel++;
      xpToNextLevel = heroLevel * 50;
      // Level-up stat boost
      attackPower += heroLevel * 2;
      maxHp += heroLevel * 10;
      hp = maxHp; // restore HP on level-up
    }}
  }}

  // â”€â”€ Player-purchased upgrades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  void upgradeAttack() {{
    level++;
    attackPower = (attackPower * 1.5).round();
    tapDamage = (tapDamage * 1.3).round();
  }}

  void upgradeDefence() {{
    defenceLevel++;
    maxHp = (maxHp * 1.25).round();
    hp = maxHp;
  }}

  void upgradeEconomy() {{
    economyLevel++;
    goldMultiplier *= 1.25;
  }}

  /// Reset for prestige â€“ clears levels but keeps prestige bonus baked in.
  void resetForPrestige(double bonus) {{
    level = 1;
    defenceLevel = 1;
    economyLevel = 1;
    heroLevel = 1;
    xp = 0;
    xpToNextLevel = 50;
    goldMultiplier = 1.0;
    applyPrestige(bonus);
  }}

  @override
  void update(double dt) {{
    super.update(dt);
    if (_isFlashing) {{
      _flashTimer -= dt;
      if (_flashTimer <= 0) _isFlashing = false;
    }}
  }}

  @override
  void render(Canvas canvas) {{
    // Body colour: white flash when attacking, blue otherwise
    final bodyColor = _isFlashing ? Colors.white : const Color(0xFF4488FF);
    canvas.drawRRect(
      RRect.fromRectAndRadius(size.toRect(), const Radius.circular(8)),
      Paint()..color = bodyColor,
    );

    // HP bar below hero body
    final hpRatio = maxHp > 0 ? hp / maxHp : 1.0;
    canvas.drawRect(
      Rect.fromLTWH(0, size.y + 4, size.x, 6),
      Paint()..color = Colors.grey.shade800,
    );
    canvas.drawRect(
      Rect.fromLTWH(0, size.y + 4, size.x * hpRatio, 6),
      Paint()..color = hpRatio > 0.4 ? Colors.greenAccent : Colors.redAccent,
    );

    // XP bar
    final xpRatio = xpToNextLevel > 0 ? xp / xpToNextLevel : 1.0;
    canvas.drawRect(
      Rect.fromLTWH(0, size.y + 12, size.x, 4),
      Paint()..color = Colors.grey.shade900,
    );
    canvas.drawRect(
      Rect.fromLTWH(0, size.y + 12, size.x * xpRatio, 4),
      Paint()..color = const Color(0xFF9333EA),
    );

    super.render(canvas);
  }}
}}
"""


def _enemy_dart(name: str) -> str:
    return f"""\
import 'package:flame/components.dart';
import 'package:flutter/material.dart';
import 'game.dart';

/// Enemy.  Boss variant spawns every 5th wave: 5Ã— HP, 5Ã— gold reward,
/// gold border, enlarged sprite, and counter-attack power.
class GameEnemy extends RectangleComponent {{
  final {name}Game game;
  final int wave;

  late int maxHp;
  late int hp;
  late int attackPower;
  bool isBoss = false;
  String enemyName = 'Enemy';

  GameEnemy({{required this.game, required this.wave}})
      : super(size: Vector2(64, 64), paint: Paint()..color = Colors.red);

  @override
  Future<void> onLoad() async {{
    isBoss = wave % 5 == 0 && wave > 0;
    if (isBoss) {{
      size = Vector2(90, 90);
      maxHp = (50 + wave * 20) * 5;
      attackPower = (wave * 3).clamp(1, 9999);
      enemyName = 'â˜… BOSS â˜…';
    }} else {{
      maxHp = 50 + wave * 20;
      attackPower = wave.clamp(1, 9999);
      enemyName = 'Lv.$wave';
    }}
    hp = maxHp;
    final cx = game.size.x * 0.65 - size.x / 2;
    final cy = game.size.y * 0.5 - size.y / 2;
    position = Vector2(cx, cy);
  }}

  @override
  void render(Canvas canvas) {{
    final ratio = maxHp > 0 ? hp / maxHp : 1.0;

    if (isBoss) {{
      // Boss: deep red fill with amber border
      canvas.drawRRect(
        RRect.fromRectAndRadius(size.toRect(), const Radius.circular(6)),
        Paint()..color = Color.lerp(Colors.deepOrange, Colors.red[900]!, 1 - ratio)!,
      );
      canvas.drawRRect(
        RRect.fromRectAndRadius(size.toRect(), const Radius.circular(6)),
        Paint()
          ..color = Colors.amber
          ..style = PaintingStyle.stroke
          ..strokeWidth = 3,
      );
    }} else {{
      paint = Paint()..color = Color.lerp(Colors.orange, Colors.red, 1 - ratio)!;
      super.render(canvas);
    }}

    // HP bar above enemy
    const barH = 6.0;
    canvas.drawRect(
      Rect.fromLTWH(0, -14, size.x, barH),
      Paint()..color = Colors.grey.shade800,
    );
    canvas.drawRect(
      Rect.fromLTWH(0, -14, size.x * ratio, barH),
      Paint()..color = isBoss ? Colors.amber : Colors.greenAccent,
    );

    // Enemy name label
    final tp = TextPaint(
      style: TextStyle(
        color: isBoss ? Colors.amber : Colors.white54,
        fontSize: isBoss ? 12 : 10,
        fontWeight: isBoss ? FontWeight.bold : FontWeight.normal,
      ),
    );
    tp.render(canvas, enemyName, Vector2(2, -26));
  }}

  void takeDamage(int amount) {{
    hp = (hp - amount).clamp(0, maxHp);
  }}
}}
"""


def _idle_manager_dart(name: str, design_doc: Optional[Dict[str, Any]] = None) -> str:
    # Use tick rate from first idle_loop in design doc if available
    tick_rate = 1.0
    if design_doc:
        loops = design_doc.get("idle_loops") or []
        for loop in loops:
            if loop.get("resource") == "combat_progress":
                tick_rate = float(loop.get("tick_rate_seconds", 1.0))
                break
    return f"""\
import 'package:flame/components.dart';
import 'game.dart';

/// Ticks the idle auto-battle loop.
/// â€“ Hero attacks the current enemy on _attackInterval / speedMultiplier.
/// â€“ Enemy counter-attacks the hero on _enemyInterval / speedMultiplier.
/// â€“ Offline catch-up awards gold for ticks that elapsed while closed.
class IdleManager extends Component {{
  final {name}Game game;

  static const double _baseAttackInterval = {tick_rate};
  static const double _baseEnemyInterval = 2.0;

  double _attackTimer = 0;
  double _enemyTimer = 0;

  IdleManager({{required this.game}});

  @override
  void onMount() {{
    super.onMount();
    _applyCatchUp();
  }}

  /// Simulate ticks that occurred while the game was closed.
  void _applyCatchUp() {{
    final lastSave = game.saveManager.lastSaveTime;
    if (lastSave == 0) return;
    final nowMs = DateTime.now().millisecondsSinceEpoch;
    final elapsed = (nowMs - lastSave) / 1000.0;
    // Cap catch-up at 8 hours
    final cappedElapsed = elapsed.clamp(0, 8 * 3600).toDouble();
    final catchUpTicks = (cappedElapsed / _baseAttackInterval).floor();
    if (catchUpTicks > 0) {{
      final catchUpGold =
          (catchUpTicks * game.hero.attackPower * 0.1 * game.prestigeBonus)
              .round();
      game.gold += catchUpGold;
    }}
  }}

  double get _attackInterval =>
      _baseAttackInterval / game.speedMultiplier;

  double get _enemyInterval =>
      _baseEnemyInterval / game.speedMultiplier;

  @override
  void update(double dt) {{
    if (game.isGameOver) return;

    _attackTimer += dt;
    if (_attackTimer >= _attackInterval) {{
      _attackTimer = 0;
      game.autoAttack();
    }}

    _enemyTimer += dt;
    if (_enemyTimer >= _enemyInterval) {{
      _enemyTimer = 0;
      game.enemyCounterAttack();
    }}
  }}
}}
"""


def _hud_dart(name: str) -> str:
    return f"""\
import 'package:flame/components.dart';
import 'package:flutter/material.dart';
import 'game.dart';

/// In-game HUD: shows gold, wave, speed, hero HP bar, XP bar.
class Hud extends PositionComponent with HasGameRef<{name}Game> {{
  static final _gold = TextPaint(
    style: const TextStyle(color: Colors.amber, fontSize: 16,
        fontWeight: FontWeight.bold),
  );
  static final _info = TextPaint(
    style: const TextStyle(color: Colors.white70, fontSize: 13),
  );

  Hud() : super(priority: 10);

  @override
  void render(Canvas canvas) {{
    final g = gameRef;
    final h = g.hero;

    // Gold (left)
    _gold.render(canvas, 'ðŸ’° ${{g.gold}}', Vector2(10, 10));

    // Diamonds (top-right)
    _gold.render(canvas, 'ðŸ’Ž ${{g.diamonds}}', Vector2(g.size.x - 80, 10));

    // Wave + speed (boss flag)
    final bossTag = g.isBossWave ? 'ðŸ‘‘ BOSS ' : '';
    _info.render(
      canvas,
      '${{bossTag}}Wave ${{g.wave}}  ${{g.speedMultiplier}}x â–¶',
      Vector2(10, 30),
    );

    // Hero level / XP
    _info.render(
      canvas,
      'Hero Lv.${{h.heroLevel}}  ${{h.xp}}/${{h.xpToNextLevel}} XP'
      '${{g.prestigeCount > 0 ? "  âœ¨${{g.prestigeCount}}" : ""}}',
      Vector2(10, 48),
    );

    // HP bar
    final hpRatio = h.maxHp > 0 ? h.hp / h.maxHp : 1.0;
    _renderBar(canvas, top: 66, ratio: hpRatio,
        full: hpRatio > 0.4 ? Colors.greenAccent : Colors.redAccent);
    _info.render(canvas, 'HP: ${{h.hp}}/${{h.maxHp}}', Vector2(154, 62));

    // XP bar
    final xpRatio = h.xpToNextLevel > 0 ? h.xp / h.xpToNextLevel : 1.0;
    _renderBar(canvas, top: 76, ratio: xpRatio,
        full: const Color(0xFF9333EA));
  }}

  void _renderBar(Canvas canvas, {{
    required double top,
    required double ratio,
    required Color full,
  }}) {{
    canvas.drawRect(Rect.fromLTWH(10, top, 140, 5),
        Paint()..color = Colors.grey.shade800);
    canvas.drawRect(Rect.fromLTWH(10, top, 140 * ratio.clamp(0, 1), 5),
        Paint()..color = full);
  }}
}}
"""


def _upgrade_overlay_dart(name: str) -> str:
    return f"""\
import 'package:flutter/material.dart';
import 'game.dart';

class UpgradeOverlay extends StatefulWidget {{
  final {name}Game game;

  const UpgradeOverlay({{required this.game, super.key}});

  @override
  State<UpgradeOverlay> createState() => _UpgradeOverlayState();
}}

class _UpgradeOverlayState extends State<UpgradeOverlay> {{
  {name}Game get game => widget.game;

  int _upgradeCost(int base, int level) => (base * (1.5 * level)).round();
  bool _canAfford(int cost) => game.gold >= cost;

  void _buy(int cost, VoidCallback apply) {{
    if (!_canAfford(cost)) return;
    setState(() {{
      game.gold -= cost;
      apply();
    }});
  }}

  @override
  Widget build(BuildContext context) {{
    final combatCost  = _upgradeCost(100, game.hero.level);
    final defenceCost = _upgradeCost(80,  game.hero.defenceLevel);
    final economyCost = _upgradeCost(120, game.hero.economyLevel);
    final canPrestige = game.wave >= 5;
    final nextBonus   = ((game.prestigeCount + 1) * 10).toInt();

    return Center(
      child: SingleChildScrollView(
        child: Container(
          padding: const EdgeInsets.all(20),
          margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 32),
          decoration: BoxDecoration(
            color: Colors.black87,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: Colors.white12),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              Text(
                '${{game.isBossWave ? "ðŸ‘‘ Boss " : ""}}Wave ${{game.wave - 1}} Complete!',
                style: const TextStyle(color: Colors.amber, fontSize: 22,
                    fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 4),
              Text('ðŸ’° ${{game.gold}}',
                  style: const TextStyle(color: Colors.white, fontSize: 16)),
              Text('Hero Lv.${{game.hero.heroLevel}}  '
                  'XP ${{game.hero.xp}}/${{game.hero.xpToNextLevel}}',
                  style: const TextStyle(color: Colors.white54, fontSize: 13)),

              // â”€â”€ Speed controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              const SizedBox(height: 12),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Text('Speed:',
                      style: TextStyle(color: Colors.white54, fontSize: 13)),
                  const SizedBox(width: 8),
                  ...[1, 2, 5].map((s) {{
                    final sel = game.speedMultiplier == s;
                    return Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 4),
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor:
                              sel ? Colors.amber : Colors.grey[800],
                          foregroundColor: sel ? Colors.black : Colors.white70,
                          minimumSize: const Size(44, 32),
                          padding: EdgeInsets.zero,
                          textStyle: const TextStyle(
                              fontSize: 13, fontWeight: FontWeight.bold),
                        ),
                        onPressed: () =>
                            setState(() => game.speedMultiplier = s),
                        child: Text('${{s}}x'),
                      ),
                    );
                  }}),
                ],
              ),

              const Divider(color: Colors.white24, height: 20),

              // â”€â”€ Upgrade buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              _UpgradeButton(
                label: 'âš” Combat (Lv.${{game.hero.level + 1}})',
                description: 'Attack +50%',
                cost: combatCost,
                canAfford: _canAfford(combatCost),
                onTap: () => _buy(combatCost, game.hero.upgradeAttack),
              ),
              const SizedBox(height: 8),
              _UpgradeButton(
                label: 'ðŸ›¡ Defence (Lv.${{game.hero.defenceLevel + 1}})',
                description: 'HP +25%',
                cost: defenceCost,
                canAfford: _canAfford(defenceCost),
                onTap: () => _buy(defenceCost, game.hero.upgradeDefence),
              ),
              const SizedBox(height: 8),
              _UpgradeButton(
                label: 'ðŸ’° Economy (Lv.${{game.hero.economyLevel + 1}})',
                description: 'Gold per wave +25%',
                cost: economyCost,
                canAfford: _canAfford(economyCost),
                onTap: () => _buy(economyCost, game.hero.upgradeEconomy),
              ),

              // â”€â”€ Prestige option (available after wave 5) â”€â”€â”€â”€â”€â”€â”€â”€â”€
              if (canPrestige) ...[
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.amber.withOpacity(0.08),
                    borderRadius: BorderRadius.circular(10),
                    border: Border.all(color: Colors.amber.withOpacity(0.3)),
                  ),
                  child: Column(
                    children: [
                      Text(
                        'âœ¨ Prestige Available',
                        style: const TextStyle(
                            color: Colors.amber, fontWeight: FontWeight.bold,
                            fontSize: 14),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        'Reset progress for permanent +${{nextBonus}}% all stats',
                        style: const TextStyle(
                            color: Colors.white54, fontSize: 12),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 8),
                      ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.amber[700],
                          foregroundColor: Colors.black,
                          minimumSize: const Size.fromHeight(36),
                          textStyle: const TextStyle(
                              fontWeight: FontWeight.bold, fontSize: 13),
                        ),
                        onPressed: () {{
                          game.overlays.remove('Upgrade');
                          game.prestige();
                        }},
                        child: const Text('âœ¨ Prestige!'),
                      ),
                    ],
                  ),
                ),
              ],

              const SizedBox(height: 12),
              TextButton(
                onPressed: () => game.overlays.remove('Upgrade'),
                child: const Text('Continue \u2192',
                    style: TextStyle(color: Colors.white70, fontSize: 16)),
              ),
            ],
          ),
        ),
      ),
    );
  }}
}}

class _UpgradeButton extends StatelessWidget {{
  final String label;
  final String description;
  final int cost;
  final bool canAfford;
  final VoidCallback onTap;

  const _UpgradeButton({{
    required this.label,
    required this.description,
    required this.cost,
    required this.canAfford,
    required this.onTap,
  }});

  @override
  Widget build(BuildContext context) {{
    return ElevatedButton(
      style: ElevatedButton.styleFrom(
        backgroundColor: canAfford ? Colors.amber[800] : Colors.grey[700],
        foregroundColor: Colors.white,
        minimumSize: const Size.fromHeight(48),
      ),
      onPressed: canAfford ? onTap : null,
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(label,
                  style: const TextStyle(fontWeight: FontWeight.bold)),
              Text(description,
                  style: const TextStyle(
                      fontSize: 12, color: Colors.white70)),
            ],
          ),
          Text('$cost ðŸª™',
              style: const TextStyle(fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }}
}}
"""


# ---------------------------------------------------------------------------
# JSON data file generators
# ---------------------------------------------------------------------------

_DEFAULT_QUESTS: List[Dict[str, Any]] = [
    {
        "title": "First Steps",
        "summary": "Begin your adventure by defeating your first enemies.",
        "giver": "Village Elder",
        "level_range": [1, 3],
        "objectives": ["Defeat 5 enemies", "Collect 50 gold"],
        "rewards": ["50 gold", "10 XP"],
    },
    {
        "title": "The Iron Trial",
        "summary": "Prove your worth against stronger foes.",
        "giver": "Guild Master",
        "level_range": [4, 8],
        "objectives": ["Defeat 10 elite enemies", "Survive 5 waves"],
        "rewards": ["200 gold", "50 XP", "Iron Amulet"],
    },
]

_DEFAULT_CHARACTERS: List[Dict[str, Any]] = [
    {
        "name": "Aela",
        "role": "Hero",
        "backstory": "A determined warrior seeking redemption.",
        "motivations": ["Protect the innocent", "Grow stronger"],
    },
    {
        "name": "Elder Mira",
        "role": "NPC",
        "backstory": "The wise keeper of ancient knowledge.",
        "motivations": ["Guide young heroes", "Preserve history"],
    },
]

_DEFAULT_ITEMS: List[Dict[str, Any]] = [
    {
        "name": "Iron Sword",
        "type": "weapon",
        "rarity": "common",
        "description": "A reliable iron sword for beginners.",
        "stats": {"attack": 5},
    },
    {
        "name": "Leather Armor",
        "type": "armor",
        "rarity": "common",
        "description": "Basic protection against attacks.",
        "stats": {"defense": 3},
    },
]

_DEFAULT_LOCATIONS: List[Dict[str, Any]] = [
    {
        "name": "Starter Village",
        "type": "town",
        "description": "A peaceful village to begin your adventure.",
        "notable_features": ["Blacksmith", "Inn", "Quest Board"],
    },
    {
        "name": "Dark Forest",
        "type": "dungeon",
        "description": "A dangerous forest filled with lurking monsters.",
        "notable_features": ["Hidden Shrine", "Bandit Camp"],
    },
]


def _quests_json(design_doc: Optional[Dict[str, Any]]) -> str:
    quests = (design_doc.get("quests") or []) if design_doc else _DEFAULT_QUESTS
    if not quests:
        quests = _DEFAULT_QUESTS
    return json.dumps(quests, indent=2)


def _characters_json(design_doc: Optional[Dict[str, Any]]) -> str:
    characters = (design_doc.get("characters") or []) if design_doc else _DEFAULT_CHARACTERS
    if not characters:
        characters = _DEFAULT_CHARACTERS
    return json.dumps(characters, indent=2)


def _items_json(design_doc: Optional[Dict[str, Any]]) -> str:
    items = (design_doc.get("items") or []) if design_doc else _DEFAULT_ITEMS
    if not items:
        items = _DEFAULT_ITEMS
    return json.dumps(items, indent=2)


def _locations_json(design_doc: Optional[Dict[str, Any]]) -> str:
    locations = (design_doc.get("locations") or []) if design_doc else _DEFAULT_LOCATIONS
    if not locations:
        locations = _DEFAULT_LOCATIONS
    return json.dumps(locations, indent=2)


_DEFAULT_ENEMIES: List[Dict[str, Any]] = [
    {
        "name": "Goblin Scout",
        "type": "humanoid",
        "description": "A small but nimble creature that attacks in packs.",
        "abilities": ["Quick Strike"],
        "loot": ["5 gold"],
    },
    {
        "name": "Orc Warrior",
        "type": "humanoid",
        "description": "A brutish orc with thick armour and a heavy axe.",
        "abilities": ["Power Slam", "Battle Cry"],
        "loot": ["20 gold", "Iron Helm"],
    },
    {
        "name": "Cave Troll",
        "type": "beast",
        "description": "A regenerating brute that guards deep dungeon passages.",
        "abilities": ["Regeneration", "Boulder Throw"],
        "loot": ["50 gold", "Troll Hide"],
    },
]


def _enemies_json(design_doc: Optional[Dict[str, Any]]) -> str:
    enemies = (design_doc.get("enemies") or []) if design_doc else _DEFAULT_ENEMIES
    if not enemies:
        enemies = _DEFAULT_ENEMIES
    return json.dumps(enemies, indent=2)


def _dialogue_json(dialogue_data: Optional[Dict[str, Any]]) -> str:
    """Serialise NPC dialogue data generated by GameDesignAgent."""
    if not dialogue_data:
        dialogue_data = {}
    return json.dumps(dialogue_data, indent=2)

# ---------------------------------------------------------------------------
# Save manager Dart file
# ---------------------------------------------------------------------------


def _save_manager_dart() -> str:
    return """\
import 'package:shared_preferences/shared_preferences.dart';

/// Persists and loads game state using SharedPreferences.
class SaveManager {
  int gold = 0;
  int diamonds = 0;
  int wave = 1;
  int heroLevel = 1;
  int xp = 0;
  int prestigeCount = 0;
  int currentDungeonLayer = 1;
  int lastSaveTime = 0;

  Future<void> load() async {
    final prefs = await SharedPreferences.getInstance();
    gold                = prefs.getInt('save_gold')           ?? 0;
    diamonds            = prefs.getInt('save_diamonds')       ?? 0;
    wave                = prefs.getInt('save_wave')           ?? 1;
    heroLevel           = prefs.getInt('save_hero_level')     ?? 1;
    xp                  = prefs.getInt('save_xp')             ?? 0;
    prestigeCount       = prefs.getInt('save_prestige')       ?? 0;
    currentDungeonLayer = prefs.getInt('save_dungeon_layer')  ?? 1;
    lastSaveTime        = prefs.getInt('save_timestamp')      ?? 0;
  }

  Future<void> save({
    required int gold,
    required int diamonds,
    required int wave,
    required int heroLevel,
    required int xp,
    required int prestigeCount,
    required int currentDungeonLayer,
  }) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt('save_gold',          gold);
    await prefs.setInt('save_diamonds',      diamonds);
    await prefs.setInt('save_wave',          wave);
    await prefs.setInt('save_hero_level',    heroLevel);
    await prefs.setInt('save_xp',            xp);
    await prefs.setInt('save_prestige',      prestigeCount);
    await prefs.setInt('save_dungeon_layer', currentDungeonLayer);
    await prefs.setInt('save_timestamp',
        DateTime.now().millisecondsSinceEpoch);
  }

  Future<void> reset() async {
    final prefs = await SharedPreferences.getInstance();
    for (final key in [
      'save_gold', 'save_diamonds', 'save_wave', 'save_hero_level',
      'save_xp', 'save_prestige', 'save_dungeon_layer', 'save_timestamp',
    ]) {
      await prefs.remove(key);
    }
    gold = 0; diamonds = 0; wave = 1; heroLevel = 1;
    xp = 0; prestigeCount = 0; currentDungeonLayer = 1; lastSaveTime = 0;
  }
}
"""


# ---------------------------------------------------------------------------
# lib/game/game_over_overlay.dart
# ---------------------------------------------------------------------------


def _game_over_overlay_dart(name: str) -> str:
    return f"""\
import 'package:flutter/material.dart';
import 'game.dart';

/// Shown when the hero's HP reaches zero.
/// Offers Watch Ad (2Ã— gold), Try Again, or Prestige.
class GameOverOverlay extends StatefulWidget {{
  final {name}Game game;

  const GameOverOverlay({{required this.game, super.key}});

  @override
  State<GameOverOverlay> createState() => _GameOverOverlayState();
}}

class _GameOverOverlayState extends State<GameOverOverlay> {{
  {name}Game get game => widget.game;
  bool _adWatched = false;

  @override
  Widget build(BuildContext context) {{
    final nextBonus = ((game.prestigeCount + 1) * 10).toInt();

    return Container(
      color: Colors.black.withOpacity(0.78),
      child: Center(
        child: SingleChildScrollView(
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 28, vertical: 24),
            margin: const EdgeInsets.symmetric(horizontal: 24),
            decoration: BoxDecoration(
              color: const Color(0xFF1a1a2e),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: Colors.redAccent, width: 2),
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Text(
                  'âš” HERO FALLEN',
                  style: TextStyle(
                    color: Colors.redAccent,
                    fontSize: 32,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 2,
                  ),
                ),
                const SizedBox(height: 10),
                Text('Reached Wave ${{game.wave}}',
                    style: const TextStyle(color: Colors.white, fontSize: 20)),
                Text('ðŸ’° Gold: ${{game.gold}}',
                    style: const TextStyle(color: Colors.amber, fontSize: 16)),
                Text('ðŸ’Ž Diamonds: ${{game.diamonds}}',
                    style: const TextStyle(color: Colors.lightBlueAccent, fontSize: 14)),
                if (game.prestigeCount > 0)
                  Text('âœ¨ Prestige level: ${{game.prestigeCount}}',
                      style: const TextStyle(color: Colors.amber, fontSize: 14)),
                const SizedBox(height: 16),

                // â”€â”€ Watch Ad â†’ 2Ã— Gold â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (!_adWatched)
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.blue.withOpacity(0.10),
                      borderRadius: BorderRadius.circular(10),
                      border: Border.all(color: Colors.blue.withOpacity(0.40)),
                    ),
                    child: Column(
                      children: [
                        const Text('ðŸ“º Double Your Gold!',
                            style: TextStyle(
                                color: Colors.lightBlueAccent,
                                fontWeight: FontWeight.bold,
                                fontSize: 14)),
                        const SizedBox(height: 4),
                        const Text('Watch a short ad to 2Ã— your current gold.',
                            style: TextStyle(color: Colors.white54, fontSize: 12),
                            textAlign: TextAlign.center),
                        const SizedBox(height: 8),
                        ElevatedButton.icon(
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.blue[700],
                            foregroundColor: Colors.white,
                            minimumSize: const Size.fromHeight(40),
                          ),
                          icon: const Icon(Icons.play_circle, size: 18),
                          label: Text(
                            game.isAdReady ? 'Watch Ad â†’ 2Ã— Gold' : 'âŒ› Loading Ad...',
                          ),
                          onPressed: game.isAdReady
                              ? () => game.watchAdForGold(
                                    onComplete: () => setState(() => _adWatched = true),
                                  )
                              : null,
                        ),
                      ],
                    ),
                  ),

                const SizedBox(height: 14),

                // â”€â”€ Prestige section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                Container(
                  padding: const EdgeInsets.all(14),
                  decoration: BoxDecoration(
                    color: Colors.amber.withOpacity(0.08),
                    borderRadius: BorderRadius.circular(10),
                    border: Border.all(
                        color: Colors.amber.withOpacity(0.35)),
                  ),
                  child: Column(
                    children: [
                      const Text(
                        'âœ¨ Prestige Available',
                        style: TextStyle(
                            color: Colors.amber,
                            fontWeight: FontWeight.bold,
                            fontSize: 15),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        'Reset and earn +$nextBonus% permanent stat bonus',
                        style: const TextStyle(
                            color: Colors.white54, fontSize: 12),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton.icon(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.amber[700],
                          foregroundColor: Colors.black,
                          minimumSize: const Size.fromHeight(42),
                          textStyle: const TextStyle(
                              fontWeight: FontWeight.bold),
                        ),
                        icon: const Text('âœ¨', style: TextStyle(fontSize: 18)),
                        label: const Text('Prestige!'),
                        onPressed: game.prestige,
                      ),
                    ],
                  ),
                ),

                const SizedBox(height: 14),
                OutlinedButton(
                  style: OutlinedButton.styleFrom(
                    foregroundColor: Colors.white70,
                    side: const BorderSide(color: Colors.white30),
                    minimumSize: const Size.fromHeight(42),
                  ),
                  onPressed: game.tryAgain,
                  child: const Text('Try Again'),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }}
}}
"""


# ---------------------------------------------------------------------------
# Flutter UI screen generators
# ---------------------------------------------------------------------------


def _quest_log_screen_dart(title: str) -> str:
    return f"""\
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// Displays the quest log loaded from assets/data/quests.json.
class QuestLogScreen extends StatefulWidget {{
  const QuestLogScreen({{super.key}});

  @override
  State<QuestLogScreen> createState() => _QuestLogScreenState();
}}

class _QuestLogScreenState extends State<QuestLogScreen> {{
  List<Map<String, dynamic>> _quests = [];
  bool _loading = true;

  @override
  void initState() {{
    super.initState();
    _loadQuests();
  }}

  Future<void> _loadQuests() async {{
    final str = await rootBundle.loadString('assets/data/quests.json');
    final list = jsonDecode(str) as List;
    setState(() {{
      _quests = list.cast<Map<String, dynamic>>();
      _loading = false;
    }});
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Quest Log'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: Colors.amber))
          : _quests.isEmpty
              ? const Center(
                  child: Text('No quests found.',
                      style: TextStyle(color: Colors.white54)))
              : ListView.builder(
                  itemCount: _quests.length,
                  padding: const EdgeInsets.symmetric(vertical: 8),
                  itemBuilder: (context, index) {{
                    final q = _quests[index];
                    final lr = (q['level_range'] as List?)
                        ?.map((e) => e.toString())
                        .join('â€“');
                    return Card(
                      color: Colors.grey[800],
                      margin: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      child: ListTile(
                        title: Text(
                          q['title'] as String? ?? '',
                          style: const TextStyle(
                              color: Colors.amber,
                              fontWeight: FontWeight.bold),
                        ),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              q['summary'] as String? ?? '',
                              style:
                                  const TextStyle(color: Colors.white70),
                            ),
                            if (q['giver'] != null)
                              Text('Giver: ${{q['giver']}}',
                                  style: const TextStyle(
                                      color: Colors.white38,
                                      fontSize: 12)),
                          ],
                        ),
                        trailing: lr != null
                            ? Text('Lv. $lr',
                                style: const TextStyle(
                                    color: Colors.white54))
                            : null,
                        isThreeLine: q['giver'] != null,
                      ),
                    );
                  }},
                ),
    );
  }}
}}
"""


def _characters_screen_dart(title: str) -> str:
    return f"""\
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// Displays the character roster loaded from assets/data/characters.json.
class CharactersScreen extends StatefulWidget {{
  const CharactersScreen({{super.key}});

  @override
  State<CharactersScreen> createState() => _CharactersScreenState();
}}

class _CharactersScreenState extends State<CharactersScreen> {{
  List<Map<String, dynamic>> _characters = [];
  bool _loading = true;

  @override
  void initState() {{
    super.initState();
    _loadCharacters();
  }}

  Future<void> _loadCharacters() async {{
    final str = await rootBundle.loadString('assets/data/characters.json');
    final list = jsonDecode(str) as List;
    setState(() {{
      _characters = list.cast<Map<String, dynamic>>();
      _loading = false;
    }});
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Characters'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: Colors.amber))
          : _characters.isEmpty
              ? const Center(
                  child: Text('No characters found.',
                      style: TextStyle(color: Colors.white54)))
              : ListView.builder(
                  itemCount: _characters.length,
                  padding: const EdgeInsets.symmetric(vertical: 8),
                  itemBuilder: (context, index) {{
                    final c = _characters[index];
                    final motivations =
                        (c['motivations'] as List?)?.join(', ') ?? '';
                    return Card(
                      color: Colors.grey[800],
                      margin: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      child: ListTile(
                        leading: CircleAvatar(
                          backgroundColor: Colors.amber,
                          child: Text(
                            (c['name'] as String? ?? '?')[0],
                            style: const TextStyle(
                                color: Colors.black,
                                fontWeight: FontWeight.bold),
                          ),
                        ),
                        title: Text(
                          c['name'] as String? ?? '',
                          style: const TextStyle(
                              color: Colors.amber,
                              fontWeight: FontWeight.bold),
                        ),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Role: ${{c['role'] ?? ''}}',
                              style: const TextStyle(color: Colors.white70),
                            ),
                            if (c['backstory'] != null)
                              Text(
                                c['backstory'] as String,
                                style: const TextStyle(
                                    color: Colors.white54,
                                    fontSize: 12),
                                maxLines: 2,
                                overflow: TextOverflow.ellipsis,
                              ),
                            if (motivations.isNotEmpty)
                              Text(
                                'Motivations: $motivations',
                                style: const TextStyle(
                                    color: Colors.white38,
                                    fontSize: 11),
                              ),
                          ],
                        ),
                        isThreeLine: true,
                      ),
                    );
                  }},
                ),
    );
  }}
}}
"""


def _shop_screen_dart(title: str) -> str:
    return f"""\
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// Displays the item shop loaded from assets/data/items.json.
class ShopScreen extends StatefulWidget {{
  const ShopScreen({{super.key}});

  @override
  State<ShopScreen> createState() => _ShopScreenState();
}}

class _ShopScreenState extends State<ShopScreen> {{
  List<Map<String, dynamic>> _items = [];
  bool _loading = true;

  @override
  void initState() {{
    super.initState();
    _loadItems();
  }}

  Future<void> _loadItems() async {{
    final str = await rootBundle.loadString('assets/data/items.json');
    final list = jsonDecode(str) as List;
    setState(() {{
      _items = list.cast<Map<String, dynamic>>();
      _loading = false;
    }});
  }}

  Color _rarityColor(String? rarity) {{
    switch (rarity?.toLowerCase()) {{
      case 'rare':
        return Colors.blue;
      case 'epic':
        return Colors.purple;
      case 'legendary':
        return Colors.orange;
      default:
        return Colors.white54;
    }}
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Shop'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: Colors.amber))
          : _items.isEmpty
              ? const Center(
                  child: Text('No items available.',
                      style: TextStyle(color: Colors.white54)))
              : ListView.builder(
                  itemCount: _items.length,
                  padding: const EdgeInsets.symmetric(vertical: 8),
                  itemBuilder: (context, index) {{
                    final item = _items[index];
                    final rarity = item['rarity'] as String?;
                    final stats = item['stats'] as Map<String, dynamic>?;
                    final statsStr = stats?.entries
                            .map((e) => '${{e.key}}: ${{e.value}}')
                            .join(', ') ??
                        '';
                    return Card(
                      color: Colors.grey[800],
                      margin: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      child: ListTile(
                        leading: Icon(
                          item['type'] == 'weapon'
                              ? Icons.security
                              : Icons.shield,
                          color: Colors.amber,
                        ),
                        title: Text(
                          item['name'] as String? ?? '',
                          style: const TextStyle(
                              color: Colors.amber,
                              fontWeight: FontWeight.bold),
                        ),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              item['description'] as String? ?? '',
                              style: const TextStyle(color: Colors.white70),
                            ),
                            if (statsStr.isNotEmpty)
                              Text('Stats: $statsStr',
                                  style: const TextStyle(
                                      color: Colors.white54,
                                      fontSize: 12)),
                          ],
                        ),
                        trailing: rarity != null
                            ? Text(
                                rarity,
                                style: TextStyle(
                                    color: _rarityColor(rarity),
                                    fontWeight: FontWeight.bold),
                              )
                            : null,
                        isThreeLine: statsStr.isNotEmpty,
                      ),
                    );
                  }},
                ),
    );
  }}
}}
"""


# ---------------------------------------------------------------------------
# Combat and Settings screen generators
# ---------------------------------------------------------------------------


def _combat_screen_dart(title: str) -> str:
    return f"""\
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// Displays the enemy encounter list loaded from assets/data/enemies.json.
class CombatScreen extends StatefulWidget {{
  const CombatScreen({{super.key}});

  @override
  State<CombatScreen> createState() => _CombatScreenState();
}}

class _CombatScreenState extends State<CombatScreen> {{
  List<Map<String, dynamic>> _enemies = [];
  bool _loading = true;

  @override
  void initState() {{
    super.initState();
    _loadEnemies();
  }}

  Future<void> _loadEnemies() async {{
    final str = await rootBundle.loadString('assets/data/enemies.json');
    final list = jsonDecode(str) as List;
    setState(() {{
      _enemies = list.cast<Map<String, dynamic>>();
      _loading = false;
    }});
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Enemies'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: Colors.amber))
          : _enemies.isEmpty
              ? const Center(
                  child: Text('No enemies found.',
                      style: TextStyle(color: Colors.white54)))
              : ListView.builder(
                  itemCount: _enemies.length,
                  padding: const EdgeInsets.symmetric(vertical: 8),
                  itemBuilder: (context, index) {{
                    final e = _enemies[index];
                    final abilities =
                        (e['abilities'] as List?)?.join(', ') ?? '';
                    final loot = (e['loot'] as List?)?.join(', ') ?? '';
                    return Card(
                      color: Colors.red[900],
                      margin: const EdgeInsets.symmetric(
                          horizontal: 12, vertical: 6),
                      child: ListTile(
                        leading: const Icon(Icons.dangerous,
                            color: Colors.amber, size: 32),
                        title: Text(
                          e['name'] as String? ?? '',
                          style: const TextStyle(
                              color: Colors.amber,
                              fontWeight: FontWeight.bold),
                        ),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              e['description'] as String? ?? '',
                              style: const TextStyle(color: Colors.white70),
                            ),
                            if (abilities.isNotEmpty)
                              Text('Abilities: $abilities',
                                  style: const TextStyle(
                                      color: Colors.white54,
                                      fontSize: 12)),
                            if (loot.isNotEmpty)
                              Text('Loot: $loot',
                                  style: const TextStyle(
                                      color: Colors.white38,
                                      fontSize: 11)),
                          ],
                        ),
                        isThreeLine: abilities.isNotEmpty,
                        trailing: e['type'] != null
                            ? Chip(
                                label: Text(
                                  e['type'] as String,
                                  style: const TextStyle(fontSize: 11),
                                ),
                                backgroundColor: Colors.black54,
                              )
                            : null,
                      ),
                    );
                  }},
                ),
    );
  }}
}}
"""


def _settings_screen_dart(title: str) -> str:
    return f"""\
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Settings screen: view game info and reset save data.
class SettingsScreen extends StatefulWidget {{
  const SettingsScreen({{super.key}});

  @override
  State<SettingsScreen> createState() => _SettingsScreenState();
}}

class _SettingsScreenState extends State<SettingsScreen> {{
  int _savedGold = 0;
  int _savedWave = 1;

  @override
  void initState() {{
    super.initState();
    _loadSaveInfo();
  }}

  Future<void> _loadSaveInfo() async {{
    final prefs = await SharedPreferences.getInstance();
    setState(() {{
      _savedGold = prefs.getInt('save_gold') ?? 0;
      _savedWave = prefs.getInt('save_wave') ?? 1;
    }});
  }}

  Future<void> _resetSave() async {{
    final confirm = await showDialog<bool>(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: Colors.grey[900],
        title: const Text('Reset Save?',
            style: TextStyle(color: Colors.amber)),
        content: const Text(
          'All progress will be lost. This cannot be undone.',
          style: TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx, false),
            child: const Text('Cancel',
                style: TextStyle(color: Colors.white54)),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            onPressed: () => Navigator.pop(ctx, true),
            child: const Text('Reset'),
          ),
        ],
      ),
    );
    if (confirm == true) {{
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove('save_gold');
      await prefs.remove('save_wave');
      await prefs.remove('save_timestamp');
      _loadSaveInfo();
      if (mounted) {{
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Save data reset.')),
        );
      }}
    }}
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Settings'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          Card(
            color: Colors.grey[800],
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('Save Data',
                      style: TextStyle(
                          color: Colors.amber,
                          fontSize: 18,
                          fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8),
                  Text('Gold: $_savedGold',
                      style: const TextStyle(color: Colors.white70)),
                  Text('Wave: $_savedWave',
                      style: const TextStyle(color: Colors.white70)),
                ],
              ),
            ),
          ),
          const SizedBox(height: 16),
          Card(
            color: Colors.grey[800],
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('About',
                      style: TextStyle(
                          color: Colors.amber,
                          fontSize: 18,
                          fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8),
                  const Text('{title}',
                      style: TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold)),
                  const Text('Generated by Aibase â€“ Idle RPG Generator',
                      style: TextStyle(color: Colors.white54, fontSize: 12)),
                ],
              ),
            ),
          ),
          const SizedBox(height: 24),
          ElevatedButton.icon(
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red[800],
              foregroundColor: Colors.white,
              minimumSize: const Size.fromHeight(48),
            ),
            icon: const Icon(Icons.delete_forever),
            label: const Text('Reset Save Data'),
            onPressed: _resetSave,
          ),
        ],
      ),
    );
  }}
}}
"""


# ---------------------------------------------------------------------------
# main.dart with bottom-navigation layout
# ---------------------------------------------------------------------------


def _main_dart_with_nav(name: str, title: str, orientation: str) -> str:
    if orientation == "landscape":
        orient_values = (
            "DeviceOrientation.landscapeLeft,\n"
            "    DeviceOrientation.landscapeRight,"
        )
    else:
        orient_values = (
            "DeviceOrientation.portraitUp,\n"
            "    DeviceOrientation.portraitDown,"
        )
    return f"""\
import 'package:flame/game.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:google_mobile_ads/google_mobile_ads.dart';
import 'game/game.dart';
import 'screens/quest_log_screen.dart';
import 'screens/characters_screen.dart';
import 'screens/dungeon_screen.dart';
import 'screens/town_map_screen.dart';
import 'screens/skills_screen.dart';
import 'screens/store_screen.dart';
import 'screens/settings_screen.dart';

void main() async {{
  WidgetsFlutterBinding.ensureInitialized();
  // Initialise Google Mobile Ads SDK before the app starts.
  await MobileAds.instance.initialize();
  await SystemChrome.setPreferredOrientations([
    {orient_values}
  ]);
  runApp(const {name}App());
}}

class {name}App extends StatefulWidget {{
  const {name}App({{super.key}});

  @override
  State<{name}App> createState() => _{name}AppState();
}}

class _{name}AppState extends State<{name}App> {{
  int _selectedIndex = 0;

  /// Stored so _SpeedButtons can read/write speedMultiplier.
  late final {name}Game _game;

  late final List<Widget> _screens;

  @override
  void initState() {{
    super.initState();
    _game = {name}Game();
    _screens = [
      // Battle tab: GameWidget with persistent speed-control overlay
      Stack(
        children: [
          GameWidget<{name}Game>(
            game: _game,
            loadingBuilder: (context) => const Center(
                child: CircularProgressIndicator(color: Colors.amber)),
          ),
          Positioned(
            bottom: 16,
            right: 16,
            child: _SpeedButtons(game: _game),
          ),
        ],
      ),
      const DungeonScreen(),
      const TownMapScreen(),
      const SkillsScreen(),
      const QuestLogScreen(),
      const StoreScreen(),
      const CharactersScreen(),
      const SettingsScreen(),
    ];
  }}

  @override
  Widget build(BuildContext context) {{
    return MaterialApp(
      title: '{title}',
      debugShowCheckedModeBanner: false,
      theme: ThemeData.dark(),
      home: Scaffold(
        backgroundColor: Colors.black,
        body: IndexedStack(
          index: _selectedIndex,
          children: _screens,
        ),
        bottomNavigationBar: BottomNavigationBar(
          backgroundColor: Colors.black,
          selectedItemColor: Colors.amber,
          unselectedItemColor: Colors.white38,
          currentIndex: _selectedIndex,
          type: BottomNavigationBarType.fixed,
          onTap: (i) => setState(() => _selectedIndex = i),
          items: const [
            BottomNavigationBarItem(
                icon: Icon(Icons.videogame_asset), label: 'Battle'),
            BottomNavigationBarItem(
                icon: Icon(Icons.castle), label: 'Dungeon'),
            BottomNavigationBarItem(
                icon: Icon(Icons.location_city), label: 'Town'),
            BottomNavigationBarItem(
                icon: Icon(Icons.auto_awesome), label: 'Skills'),
            BottomNavigationBarItem(
                icon: Icon(Icons.assignment), label: 'Quests'),
            BottomNavigationBarItem(
                icon: Icon(Icons.diamond), label: 'Store'),
            BottomNavigationBarItem(
                icon: Icon(Icons.people), label: 'Heroes'),
            BottomNavigationBarItem(
                icon: Icon(Icons.settings), label: 'Settings'),
          ],
        ),
      ),
    );
  }}
}}

/// Persistent 1Ã—/2Ã—/5Ã— speed selector shown over the battle screen.
class _SpeedButtons extends StatefulWidget {{
  final {name}Game game;
  const _SpeedButtons({{required this.game}});

  @override
  State<_SpeedButtons> createState() => _SpeedButtonsState();
}}

class _SpeedButtonsState extends State<_SpeedButtons> {{
  @override
  Widget build(BuildContext context) {{
    final cur = widget.game.speedMultiplier;
    return Container(
      decoration: BoxDecoration(
        color: Colors.black.withOpacity(0.55),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [1, 2, 5].map((s) {{
          final selected = cur == s;
          return GestureDetector(
            onTap: () => setState(() => widget.game.speedMultiplier = s),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 7),
              decoration: BoxDecoration(
                color: selected ? Colors.amber : Colors.transparent,
                borderRadius: BorderRadius.circular(6),
              ),
              child: Text(
                '${{s}}x',
                style: TextStyle(
                  color: selected ? Colors.black : Colors.white70,
                  fontWeight:
                      selected ? FontWeight.bold : FontWeight.normal,
                  fontSize: 13,
                ),
              ),
            ),
          );
        }}).toList(),
      ),
    );
  }}
}}
"""


# ---------------------------------------------------------------------------
# lib/game/damage_text.dart
# ---------------------------------------------------------------------------


def _damage_text_dart() -> str:
    return """\
import 'package:flame/components.dart';
import 'package:flutter/material.dart';

/// Floating damage number that drifts upward and fades out.
/// When [isCrit] is true it shows in red with "CRIT!" suffix and larger size.
class DamageText extends TextComponent {
  static const double _duration = 0.85;
  static const double _riseSpeed = 60;

  double _elapsed = 0;

  DamageText({
    required int amount,
    required Vector2 position,
    bool isCrit = false,
  }) : super(
          text: isCrit ? '$amount CRIT!' : '+$amount',
          textRenderer: TextPaint(
            style: TextStyle(
              color: isCrit ? Colors.redAccent : Colors.yellowAccent,
              fontSize: isCrit ? 26 : 20,
              fontWeight: FontWeight.bold,
              shadows: const [
                Shadow(
                    color: Colors.black,
                    offset: Offset(1, 1),
                    blurRadius: 2),
              ],
            ),
          ),
          position: position,
        );

  @override
  void update(double dt) {
    super.update(dt);
    _elapsed += dt;
    position.y -= _riseSpeed * dt;
    if (_elapsed >= _duration) removeFromParent();
  }
}
"""


# ---------------------------------------------------------------------------
# New data JSON generators
# ---------------------------------------------------------------------------


def _dungeon_layers_json(design_doc=None) -> str:
    """Five themed dungeon floors, each with enemies, a boss, and wave gate."""
    floors = [
        {
            "floor": 1,
            "name": "Forest Path",
            "theme": "forest",
            "description": "A misty trail through the ancient Thornwood.",
            "min_wave": 1,
            "enemies": ["Goblin Scout", "Wild Boar", "Bandit Lookout"],
            "boss": {
                "name": "Forest Troll",
                "description": "A lumbering brute guarding the forest gate.",
                "hp_multiplier": 8,
                "gold_reward": 300,
            },
        },
        {
            "floor": 2,
            "name": "Bandit Camps",
            "theme": "outdoor",
            "description": "Smoke rises from scattered outlaw encampments.",
            "min_wave": 10,
            "enemies": ["Bandit Rogue", "Crossbow Thief", "Camp Guard"],
            "boss": {
                "name": "Warlord Krang",
                "description": "Ruthless bandit chief wielding a bone axe.",
                "hp_multiplier": 10,
                "gold_reward": 600,
            },
        },
        {
            "floor": 3,
            "name": "Sunken Ruins",
            "theme": "ruins",
            "description": "Half-submerged temple ruins teeming with undead.",
            "min_wave": 20,
            "enemies": ["Skeleton Archer", "Cursed Warrior", "Drowned Shade"],
            "boss": {
                "name": "The Lich Acolyte",
                "description": "A nascent lich raising the ruins' restless dead.",
                "hp_multiplier": 12,
                "gold_reward": 1000,
            },
        },
        {
            "floor": 4,
            "name": "Crystal Caverns",
            "theme": "cave",
            "description": "Glittering crystal formations hide deadly spiders.",
            "min_wave": 35,
            "enemies": ["Crystal Spider", "Cave Troll", "Stone Golem"],
            "boss": {
                "name": "Prism Wyrm",
                "description": "A serpentine beast refracting lethal light beams.",
                "hp_multiplier": 15,
                "gold_reward": 2000,
            },
        },
        {
            "floor": 5,
            "name": "Obsidian Citadel",
            "theme": "fire",
            "description": "Volcanic fortress ruled by the infernal lord.",
            "min_wave": 50,
            "enemies": ["Infernal Knight", "Lava Golem", "Fire Succubus"],
            "boss": {
                "name": "Lord Ignarius",
                "description": "The infernal ruler of the deepest vault.",
                "hp_multiplier": 20,
                "gold_reward": 5000,
            },
        },
    ]
    return json.dumps(floors, indent=2)


def _skills_json() -> str:
    """Three skill paths (Warrior / Rogue / Mage), three skills each."""
    skills = [
        # â”€â”€ Warrior path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
            "id": "warrior_strike",
            "name": "Power Strike",
            "path": "Warrior",
            "tier": 1,
            "level_req": 5,
            "description": "Channel raw strength for +20% attack damage.",
            "effect": {"attack_bonus_pct": 20},
            "cost_diamonds": 10,
        },
        {
            "id": "warrior_shield",
            "name": "Iron Guard",
            "path": "Warrior",
            "tier": 2,
            "level_req": 15,
            "description": "Fortify your stance, reducing all damage taken by 15%.",
            "effect": {"damage_reduction_pct": 15},
            "cost_diamonds": 25,
        },
        {
            "id": "warrior_cleave",
            "name": "Whirlwind Cleave",
            "path": "Warrior",
            "tier": 3,
            "level_req": 30,
            "description": "Devastating spin attack that deals 3Ã— crit multiplier.",
            "effect": {"crit_multiplier": 3},
            "cost_diamonds": 60,
        },
        # â”€â”€ Rogue path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
            "id": "rogue_shadow",
            "name": "Shadow Strike",
            "path": "Rogue",
            "tier": 1,
            "level_req": 5,
            "description": "Increases crit chance by 10%.",
            "effect": {"crit_chance_bonus_pct": 10},
            "cost_diamonds": 10,
        },
        {
            "id": "rogue_poison",
            "name": "Venom Coat",
            "path": "Rogue",
            "tier": 2,
            "level_req": 15,
            "description": "Coats weapons in poison for +15% gold per kill.",
            "effect": {"gold_bonus_pct": 15},
            "cost_diamonds": 25,
        },
        {
            "id": "rogue_dodge",
            "name": "Evasion",
            "path": "Rogue",
            "tier": 3,
            "level_req": 30,
            "description": "20% chance to dodge enemy attacks entirely.",
            "effect": {"dodge_chance_pct": 20},
            "cost_diamonds": 60,
        },
        # â”€â”€ Mage path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
            "id": "mage_fireball",
            "name": "Fireball",
            "path": "Mage",
            "tier": 1,
            "level_req": 5,
            "description": "Launches a fireball for +25% tap damage.",
            "effect": {"tap_damage_bonus_pct": 25},
            "cost_diamonds": 10,
        },
        {
            "id": "mage_barrier",
            "name": "Arcane Barrier",
            "path": "Mage",
            "tier": 2,
            "level_req": 15,
            "description": "Magical shield raises max HP by 25%.",
            "effect": {"max_hp_bonus_pct": 25},
            "cost_diamonds": 25,
        },
        {
            "id": "mage_haste",
            "name": "Time Warp",
            "path": "Mage",
            "tier": 3,
            "level_req": 30,
            "description": "Auto-attack interval halved permanently.",
            "effect": {"attack_speed_bonus_pct": 50},
            "cost_diamonds": 60,
        },
    ]
    return json.dumps(skills, indent=2)


def _town_map_json() -> str:
    """Six town buildings with descriptions, taglines, and services."""
    buildings = [
        {
            "name": "Blacksmith",
            "emoji": "âš’ï¸",
            "tagline": "Forge & upgrade gear",
            "description": "Craft powerful weapons and reinforce your armour.",
            "services": [
                "Weapon crafting (Gold)",
                "Armour upgrades (Gold + Diamonds)",
                "Equipment repairs (free)",
            ],
        },
        {
            "name": "Tavern",
            "emoji": "ðŸº",
            "tagline": "Rest & hear rumours",
            "description": "Gather your strength and pick up quest hints from travellers.",
            "services": [
                "Full HP restore (50 Gold)",
                "Quest board refresh",
                "Rumour mill (lore snippets)",
            ],
        },
        {
            "name": "Market",
            "emoji": "ðŸª",
            "tagline": "Buy & sell items",
            "description": "Trade rare items and stock up on consumables.",
            "services": [
                "Buy consumables (Gold)",
                "Sell loot for Gold",
                "Rare item auctions (Diamonds)",
            ],
        },
        {
            "name": "Temple",
            "emoji": "â›ª",
            "tagline": "Blessings & revival",
            "description": "Receive divine blessings that boost your stats temporarily.",
            "services": [
                "Blessing of Strength (+10% ATK, 30 min)",
                "Blessing of Fortitude (+10% HP, 30 min)",
                "Resurrection (free once per day)",
            ],
        },
        {
            "name": "Barracks",
            "emoji": "ðŸ›¡ï¸",
            "tagline": "Train & recruit heroes",
            "description": "Hire companion heroes and train combat skills.",
            "services": [
                "Recruit hero companion (Diamonds)",
                "Combat training (Gold)",
                "Hero stat overview",
            ],
        },
        {
            "name": "Mage Guild",
            "emoji": "ðŸ”®",
            "tagline": "Learn spells & skills",
            "description": "The guild offers arcane training and skill unlocking.",
            "services": [
                "Unlock Mage skills (Diamonds)",
                "Spell tome library",
                "Enchant equipment (Diamonds)",
            ],
        },
    ]
    return json.dumps(buildings, indent=2)


# ---------------------------------------------------------------------------
# New screen generators
# ---------------------------------------------------------------------------


def _dungeon_screen_dart(title: str) -> str:
    return f"""\
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Displays dungeon floors loaded from assets/data/dungeon_layers.json.
/// Floors are wave-gated: a floor unlocks when save_wave >= its min_wave.
class DungeonScreen extends StatefulWidget {{
  const DungeonScreen({{super.key}});

  @override
  State<DungeonScreen> createState() => _DungeonScreenState();
}}

class _DungeonScreenState extends State<DungeonScreen> {{
  List<Map<String, dynamic>> _layers = [];
  bool _loading = true;
  int _currentWave = 1;

  @override
  void initState() {{
    super.initState();
    _load();
  }}

  Future<void> _load() async {{
    final prefs = await SharedPreferences.getInstance();
    final raw = await rootBundle.loadString('assets/data/dungeon_layers.json');
    final list = jsonDecode(raw) as List;
    setState(() {{
      _layers = list.cast<Map<String, dynamic>>();
      _currentWave = prefs.getInt('save_wave') ?? 1;
      _loading = false;
    }});
  }}

  bool _isUnlocked(Map<String, dynamic> layer) =>
      _currentWave >= (layer['min_wave'] as int? ?? 1);

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Dungeon Layers'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: Colors.amber))
          : ListView.builder(
              itemCount: _layers.length,
              padding: const EdgeInsets.all(12),
              itemBuilder: (context, i) {{
                final layer = _layers[i];
                final unlocked = _isUnlocked(layer);
                final boss = layer['boss'] as Map<String, dynamic>?;
                return Card(
                  color: unlocked ? Colors.grey[850] : Colors.grey[900],
                  margin: const EdgeInsets.only(bottom: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                    side: BorderSide(
                      color: unlocked
                          ? Colors.amber.withOpacity(0.4)
                          : Colors.white12,
                    ),
                  ),
                  child: ExpansionTile(
                    leading: CircleAvatar(
                      backgroundColor: unlocked ? Colors.amber : Colors.grey,
                      child: Text(
                        '${{layer['floor']}}',
                        style: TextStyle(
                          color: unlocked ? Colors.black : Colors.white54,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                    title: Text(
                      layer['name'] as String? ?? '',
                      style: TextStyle(
                        color: unlocked ? Colors.amber : Colors.white38,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    subtitle: Text(
                      unlocked
                          ? (layer['description'] as String? ?? '')
                          : 'Reach Wave ${{layer['min_wave']}} to unlock',
                      style: TextStyle(
                        color: unlocked ? Colors.white54 : Colors.white24,
                        fontSize: 12,
                      ),
                    ),
                    trailing: unlocked
                        ? const Icon(Icons.lock_open,
                            color: Colors.amber, size: 18)
                        : const Icon(Icons.lock,
                            color: Colors.white38, size: 18),
                    children: unlocked
                        ? [
                            Padding(
                              padding:
                                  const EdgeInsets.fromLTRB(16, 0, 16, 16),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Divider(color: Colors.white12),
                                  const Text('Enemies',
                                      style: TextStyle(
                                          color: Colors.amber,
                                          fontSize: 12,
                                          fontWeight: FontWeight.bold)),
                                  const SizedBox(height: 4),
                                  Wrap(
                                    spacing: 6,
                                    runSpacing: 4,
                                    children: (layer['enemies'] as List? ?? [])
                                        .map((e) => Chip(
                                              label: Text(e.toString(),
                                                  style: const TextStyle(
                                                      fontSize: 11,
                                                      color: Colors.white)),
                                              backgroundColor: Colors.red[900],
                                              padding: EdgeInsets.zero,
                                            ))
                                        .toList(),
                                  ),
                                  if (boss != null) ...[
                                    const SizedBox(height: 10),
                                    Container(
                                      padding: const EdgeInsets.all(10),
                                      decoration: BoxDecoration(
                                        color:
                                            Colors.amber.withOpacity(0.08),
                                        borderRadius:
                                            BorderRadius.circular(8),
                                        border: Border.all(
                                            color: Colors.amber
                                                .withOpacity(0.3)),
                                      ),
                                      child: Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            'ðŸ‘‘ Boss: ${{boss['name']}}',
                                            style: const TextStyle(
                                                color: Colors.amber,
                                                fontWeight: FontWeight.bold,
                                                fontSize: 13),
                                          ),
                                          Text(
                                            boss['description'] as String? ??
                                                '',
                                            style: const TextStyle(
                                                color: Colors.white54,
                                                fontSize: 12),
                                          ),
                                          Text(
                                            'Reward: ${{boss['gold_reward']}} Gold',
                                            style: const TextStyle(
                                                color: Colors.amber,
                                                fontSize: 12),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ],
                                ],
                              ),
                            ),
                          ]
                        : [],
                  ),
                );
              }},
            ),
    );
  }}
}}
"""


def _town_map_screen_dart(title: str) -> str:
    return f"""\
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// Interactive town map loaded from assets/data/town_map.json.
/// Each building opens a detail sheet listing its services.
class TownMapScreen extends StatefulWidget {{
  const TownMapScreen({{super.key}});

  @override
  State<TownMapScreen> createState() => _TownMapScreenState();
}}

class _TownMapScreenState extends State<TownMapScreen> {{
  List<Map<String, dynamic>> _buildings = [];
  bool _loading = true;

  @override
  void initState() {{
    super.initState();
    _load();
  }}

  Future<void> _load() async {{
    final raw = await rootBundle.loadString('assets/data/town_map.json');
    final list = jsonDecode(raw) as List;
    setState(() {{
      _buildings = list.cast<Map<String, dynamic>>();
      _loading = false;
    }});
  }}

  void _showDetail(Map<String, dynamic> building) {{
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.grey[900],
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (ctx) {{
        final services = (building['services'] as List? ?? []);
        return Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Text(building['emoji'] as String? ?? 'ðŸ ',
                      style: const TextStyle(fontSize: 36)),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          building['name'] as String? ?? '',
                          style: const TextStyle(
                              color: Colors.amber,
                              fontSize: 22,
                              fontWeight: FontWeight.bold),
                        ),
                        Text(
                          building['description'] as String? ?? '',
                          style: const TextStyle(
                              color: Colors.white54, fontSize: 13),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              if (services.isNotEmpty) ...[
                const SizedBox(height: 16),
                const Text('Services',
                    style: TextStyle(
                        color: Colors.amber,
                        fontWeight: FontWeight.bold)),
                const SizedBox(height: 8),
                ...services.map(
                  (s) => Padding(
                    padding: const EdgeInsets.symmetric(vertical: 3),
                    child: Row(
                      children: [
                        const Icon(Icons.check_circle_outline,
                            color: Colors.greenAccent, size: 16),
                        const SizedBox(width: 8),
                        Expanded(
                          child: Text(s.toString(),
                              style: const TextStyle(
                                  color: Colors.white70)),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
              const SizedBox(height: 20),
            ],
          ),
        );
      }},
    );
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Town Map'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: Colors.amber))
          : GridView.builder(
              padding: const EdgeInsets.all(16),
              gridDelegate:
                  const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 2,
                crossAxisSpacing: 12,
                mainAxisSpacing: 12,
                childAspectRatio: 1.05,
              ),
              itemCount: _buildings.length,
              itemBuilder: (context, i) {{
                final b = _buildings[i];
                return GestureDetector(
                  onTap: () => _showDetail(b),
                  child: Card(
                    color: Colors.grey[850],
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(14),
                      side: BorderSide(
                          color: Colors.amber.withOpacity(0.25)),
                    ),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Text(b['emoji'] as String? ?? 'ðŸ ',
                            style: const TextStyle(fontSize: 40)),
                        const SizedBox(height: 8),
                        Text(
                          b['name'] as String? ?? '',
                          style: const TextStyle(
                              color: Colors.amber,
                              fontWeight: FontWeight.bold),
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 4),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 6),
                          child: Text(
                            b['tagline'] as String? ?? '',
                            style: const TextStyle(
                                color: Colors.white38, fontSize: 11),
                            textAlign: TextAlign.center,
                            maxLines: 2,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                  ),
                );
              }},
            ),
    );
  }}
}}
"""


def _skills_screen_dart(name: str, title: str) -> str:
    return f"""\
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Skills & Stats screen.
/// Shows hero base stats and a 3-path skill tree loaded from
/// assets/data/skills.json.  Skills are unlocked with diamonds.
class SkillsScreen extends StatefulWidget {{
  const SkillsScreen({{super.key}});

  @override
  State<SkillsScreen> createState() => _SkillsScreenState();
}}

class _SkillsScreenState extends State<SkillsScreen> {{
  List<Map<String, dynamic>> _skills = [];
  Set<String> _unlocked = {{}};
  int _heroLevel = 1;
  int _diamonds = 0;
  bool _loading = true;

  @override
  void initState() {{
    super.initState();
    _load();
  }}

  Future<void> _load() async {{
    final prefs = await SharedPreferences.getInstance();
    final raw = await rootBundle.loadString('assets/data/skills.json');
    final list = jsonDecode(raw) as List;
    final unlockedList =
        (prefs.getStringList('unlocked_skills') ?? []).toSet();
    setState(() {{
      _skills = list.cast<Map<String, dynamic>>();
      _unlocked = unlockedList;
      _heroLevel = prefs.getInt('save_hero_level') ?? 1;
      _diamonds = prefs.getInt('save_diamonds') ?? 0;
      _loading = false;
    }});
  }}

  Future<void> _unlock(Map<String, dynamic> skill) async {{
    final cost = skill['cost_diamonds'] as int? ?? 0;
    if (_diamonds < cost) return;
    final prefs = await SharedPreferences.getInstance();
    final id = skill['id'] as String;
    _unlocked.add(id);
    _diamonds -= cost;
    await prefs.setStringList('unlocked_skills', _unlocked.toList());
    await prefs.setInt('save_diamonds', _diamonds);
    setState(() {{}});
  }}

  List<Map<String, dynamic>> _pathSkills(String path) =>
      _skills.where((s) => s['path'] == path).toList();

  Widget _skillCard(Map<String, dynamic> skill) {{
    final id = skill['id'] as String;
    final unlocked = _unlocked.contains(id);
    final lvlReq = skill['level_req'] as int? ?? 1;
    final cost = skill['cost_diamonds'] as int? ?? 0;
    final canAfford = _diamonds >= cost && _heroLevel >= lvlReq;
    final locked = _heroLevel < lvlReq;

    return Card(
      color: unlocked
          ? Colors.green.shade900.withOpacity(0.4)
          : Colors.grey[850],
      margin: const EdgeInsets.symmetric(vertical: 6, horizontal: 12),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(10),
        side: BorderSide(
          color: unlocked
              ? Colors.greenAccent.withOpacity(0.4)
              : Colors.white12,
        ),
      ),
      child: ListTile(
        leading: Icon(
          unlocked ? Icons.auto_awesome : Icons.lock_outline,
          color: unlocked ? Colors.greenAccent : Colors.white38,
        ),
        title: Text(
          skill['name'] as String? ?? '',
          style: TextStyle(
            color: unlocked ? Colors.greenAccent : Colors.white,
            fontWeight: FontWeight.bold,
          ),
        ),
        subtitle: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              skill['description'] as String? ?? '',
              style: const TextStyle(color: Colors.white54, fontSize: 12),
            ),
            const SizedBox(height: 2),
            Text(
              locked
                  ? 'Requires Hero Lv.$lvlReq'
                  : unlocked
                      ? 'âœ“ Unlocked'
                      : 'ðŸ’Ž $cost diamonds',
              style: TextStyle(
                color: locked
                    ? Colors.red[300]
                    : unlocked
                        ? Colors.greenAccent
                        : Colors.lightBlueAccent,
                fontSize: 11,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
        trailing: unlocked
            ? const Icon(Icons.check_circle, color: Colors.greenAccent)
            : ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor:
                      canAfford ? Colors.blue[700] : Colors.grey[700],
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(
                      horizontal: 12, vertical: 6),
                  minimumSize: const Size(64, 32),
                  textStyle: const TextStyle(fontSize: 12),
                ),
                onPressed: (canAfford && !locked) ? () => _unlock(skill) : null,
                child: const Text('Unlock'),
              ),
      ),
    );
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Skills & Stats'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(child: CircularProgressIndicator(color: Colors.amber))
          : Column(
              children: [
                // â”€â”€ Stat bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                Container(
                  padding: const EdgeInsets.symmetric(
                      horizontal: 16, vertical: 10),
                  color: Colors.grey[850],
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceAround,
                    children: [
                      _statBadge('Lv.', '$_heroLevel', Colors.amber),
                      _statBadge('ðŸ’Ž', '$_diamonds', Colors.lightBlueAccent),
                      _statBadge('âœ“', '${{_unlocked.length}}/${{_skills.length}}',
                          Colors.greenAccent),
                    ],
                  ),
                ),
                // â”€â”€ Tab view per skill path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                Expanded(
                  child: DefaultTabController(
                    length: 3,
                    child: Column(
                      children: [
                        const TabBar(
                          indicatorColor: Colors.amber,
                          labelColor: Colors.amber,
                          unselectedLabelColor: Colors.white38,
                          tabs: [
                            Tab(text: 'âš” Warrior'),
                            Tab(text: 'ðŸ—¡ Rogue'),
                            Tab(text: 'ðŸ”® Mage'),
                          ],
                        ),
                        Expanded(
                          child: TabBarView(
                            children: ['Warrior', 'Rogue', 'Mage']
                                .map(
                                  (path) => ListView(
                                    padding: const EdgeInsets.symmetric(
                                        vertical: 8),
                                    children: _pathSkills(path)
                                        .map(_skillCard)
                                        .toList(),
                                  ),
                                )
                                .toList(),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
    );
  }}

  Widget _statBadge(String label, String value, Color color) {{
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(value,
            style: TextStyle(
                color: color, fontSize: 18, fontWeight: FontWeight.bold)),
        Text(label,
            style: const TextStyle(color: Colors.white38, fontSize: 11)),
      ],
    );
  }}
}}
"""


def _store_screen_dart(title: str) -> str:
    return f"""\
import 'package:flutter/material.dart';
import 'package:in_app_purchase/in_app_purchase.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Diamond store: buy diamond bundles with real money (in_app_purchase).
/// Uses Google Play / App Store product IDs defined in _kProductIds.
/// Replace the test product IDs before publishing.
class StoreScreen extends StatefulWidget {{
  const StoreScreen({{super.key}});

  @override
  State<StoreScreen> createState() => _StoreScreenState();
}}

// Product IDs must match exactly what you define in the store consoles.
const Set<String> _kProductIds = {{
  'diamonds_50',
  'diamonds_150',
  'diamonds_500',
  'diamonds_1200',
}};

const Map<String, int> _kDiamondAmounts = {{
  'diamonds_50':   50,
  'diamonds_150':  150,
  'diamonds_500':  500,
  'diamonds_1200': 1200,
}};

const Map<String, String> _kFallbackPrices = {{
  'diamonds_50':   '\u00240.99',
  'diamonds_150':  '\u00242.99',
  'diamonds_500':  '\u00247.99',
  'diamonds_1200': '\u002417.99',
}};

class _StoreScreenState extends State<StoreScreen> {{
  final InAppPurchase _iap = InAppPurchase.instance;
  List<ProductDetails> _products = [];
  bool _available = false;
  bool _loading = true;
  int _diamonds = 0;

  @override
  void initState() {{
    super.initState();
    _initStore();
  }}

  Future<void> _initStore() async {{
    final prefs = await SharedPreferences.getInstance();
    _diamonds = prefs.getInt('save_diamonds') ?? 0;
    _available = await _iap.isAvailable();
    if (_available) {{
      final response = await _iap.queryProductDetails(_kProductIds);
      _products = response.productDetails;
      // Sort by diamond amount ascending
      _products.sort((a, b) =>
          (_kDiamondAmounts[a.id] ?? 0)
              .compareTo(_kDiamondAmounts[b.id] ?? 0));
      _iap.purchaseStream.listen(_handlePurchase);
    }}
    setState(() => _loading = false);
  }}

  void _handlePurchase(List<PurchaseDetails> details) async {{
    for (final purchase in details) {{
      if (purchase.status == PurchaseStatus.purchased ||
          purchase.status == PurchaseStatus.restored) {{
        final amount = _kDiamondAmounts[purchase.productID] ?? 0;
        final prefs = await SharedPreferences.getInstance();
        final current = prefs.getInt('save_diamonds') ?? 0;
        await prefs.setInt('save_diamonds', current + amount);
        setState(() => _diamonds = current + amount);
      }}
      if (purchase.pendingCompletePurchase) {{
        await _iap.completePurchase(purchase);
      }}
    }}
  }}

  void _buy(ProductDetails product) {{
    final param = PurchaseParam(productDetails: product);
    _iap.buyConsumable(purchaseParam: param);
  }}

  @override
  Widget build(BuildContext context) {{
    return Scaffold(
      appBar: AppBar(
        title: const Text('Diamond Store'),
        backgroundColor: Colors.black,
        foregroundColor: Colors.amber,
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: 16),
            child: Row(
              children: [
                const Icon(Icons.diamond, color: Colors.lightBlueAccent,
                    size: 18),
                const SizedBox(width: 4),
                Text(
                  '$_diamonds',
                  style: const TextStyle(
                      color: Colors.lightBlueAccent,
                      fontWeight: FontWeight.bold),
                ),
              ],
            ),
          ),
        ],
      ),
      backgroundColor: Colors.grey[900],
      body: _loading
          ? const Center(
              child: CircularProgressIndicator(color: Colors.amber))
          : Column(
              children: [
                // Current balance banner
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.symmetric(
                      vertical: 12, horizontal: 20),
                  color: const Color(0xFF0d1b2a),
                  child: Row(
                    children: [
                      const Icon(Icons.diamond,
                          color: Colors.lightBlueAccent, size: 28),
                      const SizedBox(width: 10),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text('Your Diamonds',
                              style: TextStyle(
                                  color: Colors.white54, fontSize: 12)),
                          Text(
                            '$_diamonds',
                            style: const TextStyle(
                                color: Colors.lightBlueAccent,
                                fontSize: 28,
                                fontWeight: FontWeight.bold),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 8),
                const Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                  child: Text('Buy Diamonds',
                      style: TextStyle(
                          color: Colors.amber,
                          fontSize: 16,
                          fontWeight: FontWeight.bold)),
                ),
                Expanded(
                  child: !_available
                      ? const Center(
                          child: Text(
                            'Store unavailable.\nConfigure product IDs in the Play Console / App Store Connect.',
                            style: TextStyle(
                                color: Colors.white54, fontSize: 13),
                            textAlign: TextAlign.center,
                          ),
                        )
                      : _products.isEmpty
                          ? const Center(
                              child: Text(
                                'No products found.\nEnsure product IDs match the store console.',
                                style: TextStyle(
                                    color: Colors.white54, fontSize: 13),
                                textAlign: TextAlign.center,
                              ),
                            )
                          : ListView.builder(
                              padding: const EdgeInsets.all(12),
                              itemCount: _products.length,
                              itemBuilder: (context, i) {{
                                final p = _products[i];
                                final amount =
                                    _kDiamondAmounts[p.id] ?? 0;
                                return Card(
                                  color: Colors.grey[850],
                                  margin:
                                      const EdgeInsets.only(bottom: 10),
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12),
                                    side: BorderSide(
                                        color: Colors.lightBlueAccent
                                            .withOpacity(0.3)),
                                  ),
                                  child: ListTile(
                                    leading: const Icon(Icons.diamond,
                                        color: Colors.lightBlueAccent,
                                        size: 32),
                                    title: Text(
                                      '$amount ðŸ’Ž',
                                      style: const TextStyle(
                                          color: Colors.white,
                                          fontSize: 18,
                                          fontWeight: FontWeight.bold),
                                    ),
                                    subtitle: Text(
                                      p.description,
                                      style: const TextStyle(
                                          color: Colors.white54,
                                          fontSize: 12),
                                    ),
                                    trailing: ElevatedButton(
                                      style: ElevatedButton.styleFrom(
                                        backgroundColor:
                                            Colors.lightBlueAccent,
                                        foregroundColor: Colors.black,
                                        textStyle: const TextStyle(
                                            fontWeight: FontWeight.bold),
                                      ),
                                      onPressed: () => _buy(p),
                                      child: Text(p.price),
                                    ),
                                  ),
                                );
                              }},
                            ),
                ),
              ],
            ),
    );
  }}
}}
"""


def _ad_service_dart() -> str:
    return """\
import 'package:google_mobile_ads/google_mobile_ads.dart';

/// Wraps Google Mobile Ads rewarded ad loading and display.
///
/// Uses the standard Google test ad unit IDs.
/// IMPORTANT: Replace _rewardedAdUnitId with your production ad unit ID
/// before publishing to the Play Store / App Store.
class AdService {
  // Test rewarded ad unit ID â€“ replace before publishing.
  // Android: ca-app-pub-3940256099942544/5224354917
  // iOS:     ca-app-pub-3940256099942544/1712485313
  static const String _rewardedAdUnitId =
      'ca-app-pub-3940256099942544/5224354917';

  RewardedAd? _rewardedAd;
  bool _isAdLoaded = false;

  Future<void> initialize() async {
    await MobileAds.instance.initialize();
    _loadAd();
  }

  bool get isAdReady => _isAdLoaded && _rewardedAd != null;

  void _loadAd() {
    RewardedAd.load(
      adUnitId: _rewardedAdUnitId,
      request: const AdRequest(),
      rewardedAdLoadCallback: RewardedAdLoadCallback(
        onAdLoaded: (ad) {
          _rewardedAd = ad;
          _isAdLoaded = true;
        },
        onAdFailedToLoad: (error) {
          _isAdLoaded = false;
          _rewardedAd = null;
        },
      ),
    );
  }

  /// Show a rewarded ad.
  ///
  /// [onRewarded] is called with the reward amount when the user earns it.
  /// [onDismissed] is called when the ad is closed (reward granted or not).
  void showRewardedAd({
    required void Function(int goldBonus) onRewarded,
    VoidCallback? onDismissed,
  }) {
    if (!isAdReady) return;
    _rewardedAd!.fullScreenContentCallback = FullScreenContentCallback(
      onAdDismissedFullScreenContent: (ad) {
        ad.dispose();
        _isAdLoaded = false;
        _rewardedAd = null;
        onDismissed?.call();
        _loadAd(); // pre-load next ad
      },
      onAdFailedToShowFullScreenContent: (ad, error) {
        ad.dispose();
        _isAdLoaded = false;
        _rewardedAd = null;
        _loadAd();
      },
    );
    _rewardedAd!.show(
      onUserEarnedReward: (ad, reward) {
        onRewarded(reward.amount.toInt());
      },
    );
  }
}
"""
